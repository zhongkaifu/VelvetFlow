<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VelvetFlow Workflow Studio</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <header class="app__header">
      <div class="title-block">
        <img src="/logo.jpg" alt="VelvetFlow logo" class="logo" />
        <div>
          <div class="eyebrow">VelvetFlow Agent Playground</div>
          <h1>可视化 Workflow Builder</h1>
          <p class="subtitle">用自然语言描述需求，自动构建、修改并运行可视化 DAG。</p>
        </div>
      </div>
    </header>

    <main class="layout">
      <section class="canvas-panel">
        <div class="tab-bar" role="tablist">
          <button class="tab" data-tab="json" role="tab" aria-selected="false">Workflow JSON</button>
          <button class="tab tab--active" data-tab="visual" role="tab" aria-selected="true">流程图视图</button>
        </div>
        <div class="tab-content tab-content--hidden" data-view="json">
          <div class="editor">
            <div class="editor__header">
              <h3>Workflow JSON</h3>
              <div class="editor__actions">
                <input id="loadWorkflowFile" type="file" accept="application/json" class="visually-hidden" />
                <button id="loadWorkflow" class="button button--ghost">从文件加载</button>
                <button id="saveWorkflow" class="button button--ghost">保存到文件</button>
                <button id="resetWorkflow" class="button button--ghost">重置</button>
                <button id="applyWorkflow" class="button">应用修改</button>
              </div>
            </div>
            <p class="muted">您可以直接编辑 DAG，VelvetFlow 会重新渲染画布。</p>
            <textarea id="workflowEditor" spellcheck="false" aria-label="workflow json"></textarea>
          </div>
        </div>
        <div class="tab-content" data-view="visual">
          <div class="canvas-wrapper">
            <div class="canvas-toolbar">
              <div class="canvas-toolbar__group">
                <button type="button" class="icon-button" id="zoomOut" aria-label="缩小">−</button>
                <span class="canvas-toolbar__label" id="zoomValue">100%</span>
                <button type="button" class="icon-button" id="zoomIn" aria-label="放大">＋</button>
              </div>
              <button type="button" class="button button--ghost" id="resetView">重置视图</button>
            </div>
            <div id="canvasHost">
              <canvas id="workflowCanvas" width="1080" height="620" aria-label="workflow canvas"></canvas>
              <p class="muted tab-hint">提示：在画布空白处右键添加节点，双击节点可编辑参数或跳转循环子图；编辑弹窗内可删除节点。</p>
            </div>
            <div id="addNodeMenu" class="context-menu hidden" role="dialog" aria-modal="true" aria-label="添加节点">
              <div class="context-menu__header">
                <h4>添加新节点</h4>
                <button type="button" class="context-menu__close" aria-label="关闭" id="closeAddNodeMenu">×</button>
              </div>
              <label class="context-menu__field">
                <span>节点类型</span>
                <select id="addNodeType" class="context-menu__input">
                  <option value="action" selected>动作 (action)</option>
                  <option value="condition">条件 (condition)</option>
                  <option value="loop">循环 (loop)</option>
                </select>
              </label>
              <label class="context-menu__field">
                <span>显示名称（可选）</span>
                <input id="addNodeName" class="context-menu__input" placeholder="例如：审批节点" />
              </label>
              <label class="context-menu__field" id="addNodeActionRow">
                <span>业务工具 (action_id)</span>
                <select id="addNodeActionSelect" class="context-menu__input" aria-label="选择业务工具"></select>
              </label>
              <div class="context-menu__actions">
                <button type="button" class="button button--ghost" id="cancelAddNode">取消</button>
                <button type="button" class="button button--primary" id="confirmAddNode">添加节点</button>
              </div>
              <p class="muted context-menu__hint">提示：节点会自动布局，若需要拖动可按住节点移动位置。</p>
            </div>
          </div>
        </div>
      </section>

      <section class="chat-panel">
        <div class="panel__header">
          <div>
            <h2>VelvetFlow Agent 对话框</h2>
            <p class="muted">输入自然语言需求以构建或迭代 workflow，构建进度会实时展示。</p>
          </div>
          <div class="status" id="statusIndicator">等待输入</div>
        </div>
        <div class="chat-log" id="chatLog" aria-live="polite"></div>
        <form id="chatForm" class="chat-input" autocomplete="off">
          <label class="visually-hidden" for="userInput">需求输入</label>
          <textarea id="userInput" placeholder="例如：为新员工入职构建流程，包含账号申请、设备分配和审批" required></textarea>
          <div class="chat-actions">
            <button type="button" id="editHelp" class="button button--ghost" title="如何修改现有 workflow">修改说明</button>
            <div class="chat-actions__group">
              <button type="submit" class="button button--primary">构建工作流</button>
              <button type="button" id="runWorkflow" class="button button--primary">运行 workflow</button>
            </div>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script src="js/core.js"></script>
  <script src="js/dialogs.js"></script>
  <script src="js/canvas.js"></script>
  <script src="js/network.js"></script>
  <script src="js/interactions.js"></script>
</body>
</html>
